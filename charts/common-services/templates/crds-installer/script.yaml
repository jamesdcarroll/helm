apiVersion: v1
kind: ConfigMap
metadata:
  name: {{ include "common-services.name" . }}-crds-installer-scripts
  annotations:
    "helm.sh/hook": pre-install,pre-upgrade
    "helm.sh/hook-weight": "-10"
    "helm.sh/hook-delete-policy": hook-succeeded,before-hook-creation
    "argocd.argoproj.io/hook": PreSync
    "argocd.argoproj.io/hook-delete-policy": HookSucceeded,BeforeHookCreation
data:  
  install-crds.sh: |
    #!/bin/sh

    set -euo pipefail
    
    # Cleanup function
    cleanup() {
      echo "üßπ Cleaning up temporary files..."
      rm -f /tmp/*_rendered.yaml /tmp/*_crds.yaml
      echo
    }
    
    # Trap to ensure cleanup on exit
    trap cleanup EXIT

    # Function to install CRDs for a given chart
    install_crds() {
      local name=$1
      local repository=$2
      local version=$3
      local crd_pattern=$4
      local chart_name=$5
      local enabled=$6

      echo "üöÄ === Installing CRDs for $name ==="
      echo "   ‚ÑπÔ∏è  Repository: $repository"
      echo "   ‚ÑπÔ∏è  Version: $version"
      echo "   ‚ÑπÔ∏è  CRD Pattern: $crd_pattern"
      echo "   ‚ÑπÔ∏è  Chart Name: $chart_name"
      
      # Add repository
      echo "‚¨áÔ∏è Adding $name repository..."
      helm repo add "$name" "$repository" >/dev/null 2>&1
      
      # Update repositories
      echo "üîÑ Updating helm repositories..."
      helm repo update >/dev/null 2>&1
      
      # Render CRDs
      echo "‚öôÔ∏è Rendering $name CRDs version $version..."
      helm template "$name" "$name/$chart_name" --include-crds --version "$version" > "/tmp/${name}_rendered.yaml"
      
      # Filter CRDs
      echo "üîç Filtering $name CRDs..."
      yq e 'select(.kind == "CustomResourceDefinition")' "/tmp/${name}_rendered.yaml" > "/tmp/${name}_crds.yaml"
      
      # Remove last-applied-configuration annotation
      echo "üßπ  Removing 'last-applied-configuration' annotation from existing CRDs..."
      for crd in $(kubectl get crd -o name | grep "$crd_pattern" || true); do
        kubectl annotate "$crd" kubectl.kubernetes.io/last-applied-configuration- >/dev/null 2>&1 || true
        echo "‚úÖ 'last-applied-configuration' annotation removed from $crd successfully"
      done
      echo "‚úÖ 'last-applied-configuration' annotation removed from existing CRDs successfully"
      
      # Fix ArgoCD OutOfSync on CRDs regarding the attribute "priority" with default value 0 removed by Kubernetes
      echo "üîç Fixing ArgoCD OutOfSync on CRDs regarding the attribute 'priority' with default value 0 removed by Kubernetes..."
      yq -i 'del(.. | select(tag == "!!map" and .priority == 0).priority)' "/tmp/${name}_crds.yaml"
      echo "‚úÖ ArgoCD OutOfSync on CRDs regarding the attribute 'priority' with default value 0 removed by Kubernetes fixed successfully"

      # Apply CRDs
      echo "üìã Applying $name CRDs..."
      kubectl --server-side --force-conflicts apply -f "/tmp/${name}_crds.yaml" >/dev/null 2>&1
      echo "‚úÖ === $name CRDs installation completed ==="
      echo
    }
  
    # Read CRDs configuration from ConfigMap
    echo "üìÑ Reading CRDs configuration from ConfigMap..."
    CONFIG_FILE="/etc/config/crds-installer-config.yaml"
    
    if [ ! -f "$CONFIG_FILE" ]; then
      echo "‚ùå Error: CRDs configuration file not found at $CONFIG_FILE"
      exit 1
    fi
    
    # Parse YAML and install CRDs for each enabled chart
    echo "üîç Parsing CRDs configuration..."
    
    # Validate YAML syntax first
    if ! yq e '.' "$CONFIG_FILE" > /dev/null 2>&1; then
      echo "‚ùå Error: Invalid YAML syntax in configuration file"
      exit 1
    fi
    echo "‚úÖ Configuration file validated successfully"
    echo
    
    # Check if there are any enabled CRDs to install
    if [ ! -n "$(yq eval -r '.[] | select(.enabled == true)' "$CONFIG_FILE")" ]; then
      echo "‚ö†Ô∏è No CRDs to install or update, probably because charts with CRDs are disabled or not part of this process"
      exit 0
    fi
        
    # Read and execute CRDs configuration
    while IFS=$'\t' read -r name repository version crd_pattern chart_name enabled; do
        install_crds "$name" "$repository" "$version" "$crd_pattern" "$chart_name" "$enabled"
    done < <(
        yq eval -r '.[] | select(.enabled == true) | [.name, .repository, .version, .crd_pattern, .chart_name, .enabled] | @tsv' "$CONFIG_FILE"
    )
    
    echo "‚úÖ All CRDs installations completed successfully!"
