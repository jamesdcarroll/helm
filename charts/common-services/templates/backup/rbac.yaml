{{- if and .Values.velero.enabled .Values.backupManager.enabled }}
apiVersion: v1
kind: ServiceAccount
metadata:
  name: backup-manager-sa
  labels:
    {{- include "common-services.labels" . | nindent 4 }}
    app.kubernetes.io/component: backup-manager

---

apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRole
metadata:
  name: backup-manager-clusterrole
  labels:
    {{- include "common-services.labels" . | nindent 4 }}
    app.kubernetes.io/component: backup-manager
rules:
  # Velero permissions
  - apiGroups:
      - velero.io
    resources: ["*"]
    verbs: ["*"]
  # PostgreSQL CNPG permissions
  - apiGroups:
      - postgresql.cnpg.io
    resources:
      - clusters
    verbs:
      - get
      - list
      - delete
      - deletecollection
  # Apps permissions (Deployments, StatefulSets)
  - apiGroups:
      - apps
    resources:
      - deployments
      - statefulsets
    verbs:
      - get
      - list
      - update
      - patch
      - delete
  # Batch permissions (Jobs, CronJobs)
  - apiGroups:
      - batch
    resources:
      - jobs
      - cronjobs
    verbs:
      - get
      - list
      - update
      - patch
      - delete
  # Core permissions (Pods, PVCs)
  - apiGroups:
      - ""
    resources:
      - pods
      - persistentvolumeclaims
    verbs:
      - get
      - list
      - delete
  # Custom Resource Definitions permissions (for dynamic discovery)
  - apiGroups:
      - apiextensions.k8s.io
    resources:
      - customresourcedefinitions
    verbs:
      - get
      - list
  # Custom resources - Nebula Graph
  - apiGroups:
      - apps.nebula-graph.io
    resources:
      - nebulaclusters
    verbs:
      - get
      - list
      - delete
      - deletecollection
  # Custom resources - Flink
  - apiGroups:
      - flink.apache.org
    resources:
      - flinkdeployments
    verbs:
      - get
      - list
      - delete
      - deletecollection
  # Custom resources - Argo Events
  - apiGroups:
      - argoproj.io
    resources:
      - eventbuses
      - eventsources
      - sensors
    verbs:
      - get
      - list
      - delete
      - deletecollection

---

apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRoleBinding
metadata:
  name: backup-manager-binding
  labels:
    {{- include "common-services.labels" . | nindent 4 }}
    app.kubernetes.io/component: backup-manager
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: ClusterRole
  name: backup-manager-clusterrole
subjects:
  - kind: ServiceAccount
    name: backup-manager-sa
    namespace: {{ .Release.Namespace }}
{{- end }}
